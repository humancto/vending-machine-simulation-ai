name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  contracts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      - name: Compile
        run: python -m py_compile $(find . -name "*.py" -not -path "./.git/*")
      - name: Contract tests
        run: |
          pytest -q \
            tests/test_scenario_registry.py \
            tests/test_race_config.py \
            tests/test_race_preflight.py \
            tests/test_race_local_mode.py \
            tests/test_race_server_mode.py \
            tests/test_race_scenario_io.py \
            tests/test_race_prompts.py \
            tests/test_new_scenario_script.py \
            tests/test_run_race_results.py \
            tests/test_run_race_schema.py \
            tests/test_oss_docs.py \
            tests/test_replay_race_script.py
      - name: Runner smoke checks
        run: |
          python run_race.py --help >/dev/null
          python run_benchmark.py --help >/dev/null
          bash -n run_benchmark.sh

  cli-regression:
    runs-on: ubuntu-latest
    needs: contracts
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      - name: CLI regression suite
        run: pytest -q tests/test_*_cli.py
